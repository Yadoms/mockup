class Yadoms {
  components = {};
  pages = [];
  $style = null;

  // CMS : card management system
  masis = null;
  masisMove = null;
  masisResize = null;
  masisDelete = null;
  breakpoints = {
    width: [],
    height: [],
  };
  maxCardWidthSize = 5;
  maxCardHeightSize = 5;
  positionOptions = {
    pad: 154,
  };

  constructor() {
    console.log(
      "\
  __ __       _                \n\
 |  |  |___ _| |___ _____ ___  \n\
 |_   _| .'| . | . |     |_ -| \n\
   |_| |__,|___|___|_|_|_|___| \n\
 \n\
 Welcome to the dev world!\n\
 To have any help, type yadoms.help()\
 "
    );
    if (
      window.matchMedia &&
      window.matchMedia('(prefers-color-scheme: dark)').matches
    )
      this.changeTheme('dark');
    else this.changeTheme('light');
    // creation of a style balise to insert all components styles
    this.$style = document.createElement('style');
    document.querySelector('head').appendChild(this.$style);
  }

  help(func = '') {
    if (func != '') {
      if ('changeTheme' == func) {
        console.log('List of available themes');
        console.table(['light', 'dark', 'lidrea']);
      }
    } else if ('' == func) {
      console.log('List of available functions');
      console.table({
        'yadoms.lightOn()': 'Change the current theme to the light mode',
        'yadoms.lightOff()': 'Change the current theme to the dark mode',
        'yadoms.changeTheme(theme)':
          'Change the current theme to a specific theme',
      });
      console.log(
        'To have more information about a function, gives the name of the function in parameter.'
      );
      console.info("Example : yadoms.help('changeTheme').");
    } else {
      console.log('no documentation for this function');
    }
  }

  lightOn() {
    return this.changeTheme('');
  }

  lightOff() {
    return this.changeTheme('dark');
  }

  changeTheme(theme) {
    if ('' == theme) theme = 'light';
    document.querySelector('link[id="theme"]').href = `/css/${theme}.min.css`;
    return 'The theme is set to ' + theme + ' now';
  }

  static ready(fn) {
    if (document.readyState != 'loading') {
      fn();
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  }

  static triggerEvent(eventName, data = {}) {
    if (window.CustomEvent && typeof window.CustomEvent === 'function') {
      var event = new CustomEvent(eventName, { detail: data });
    } else {
      var event = document.createEvent('CustomEvent');
      event.initCustomEvent(eventName, true, true, data);
    }
    document.dispatchEvent(event);
  }

  createMenu() {
    const $sidebar = document.querySelector('nav#menu ul');
    this.pages.forEach((page) => {
      let $item = document.createElement('li');
      $item.innerHTML = `
        <a
          class="text-primaryColor hover:text-highlightColor"
          href="#/${page.slug}"
        >
          <span class="icon">
            <i class="fas fa-${page.icon}"></i>
          </span>
          <span class="word md:pb-0">${page.name}</span>
        </a>
      `;
      $sidebar.appendChild($item);
    });
  }

  createNavigationSystem() {
    let $items = document.querySelectorAll('nav#menu ul li a');
    var self = this;
    $items.forEach(($el) => {
      $el.addEventListener(
        'click',
        (ev) => {
          ev.stopImmediatePropagation();
          self.viewPage(ev.currentTarget.getAttribute('href').slice(2));
        },
        false
      );
    });
  }

  createCard(
    width,
    height,
    title = '',
    content = '',
    battery = -1,
    signal = -1
  ) {
    let $div = document.createElement('div');
    let cls = ['card', 'text-primaryColor', 'bg-baseColor'];
    $div.classList.add(...cls);
    let batteryContent = '';
    let signalContent = '';
    if (battery != -1) {
      let icon = '';
      if (0 == battery) icon = 'fas fa-battery-empty red';
      else if (0.25 == battery) icon = 'fas fa-battery-quarter';
      else if (0.5 == battery) icon = 'fas fa-battery-half';
      else if (0.75 == battery) icon = 'fas fa-three-battery-half';
      else if (1 == battery) icon = 'fas fa-battery-full text-green-600';
      batteryContent = `<span class="icon"><i class="${icon}"></i></span>`;
    }
    if (signal != -1) {
      let cl = '';
      if (signal < 0.5) cl = 'red';
      signalContent = `<span class="icon"><i class="fas fa-wifi ${cl}"></i></span>`;
    }
    $div.innerHTML = `
      <div class="card-title clearfix card-width-${width}">
        ${batteryContent}
        ${signalContent}
        <span class="title">${title}</span>
      </div>
      <div class="card-wrapper flex-grow">
        <div class="card-width-${width} card-height-${height}">
          ${content}
        </div>
      </div>
    `;
    return $div;
  }

  static changeCardTitle($element, content) {
    let $cardtitle = $element.querySelector('.card-title');
    let $title = $cardtitle.querySelector('.title');
    $title.innerHTML = content;
    if (content == '') $cardtitle.classList.add('no-border');
    else $cardtitle.classList.remove('no-border');
  }

  createCardManagementSystem() {
    this.masis = new Masis('#cards');
    let self = this;

    for (
      let i = 1;
      i <= Math.max(this.maxCardWidthSize, this.maxCardHeightSize);
      i++
    ) {
      const $div = this.createCard(
        Math.min(i, this.maxCardWidthSize),
        Math.min(i, this.maxCardHeightSize)
      );
      document.querySelector('#cards').appendChild($div);
      const style = getComputedStyle($div);
      const rect = $div.getBoundingClientRect();
      let $iw, $ih;
      $iw =
        parseInt(rect.width) +
        parseInt(style.marginLeft) +
        parseInt(style.marginRight);
      $ih =
        parseInt(rect.height) +
        parseInt(style.marginTop) +
        parseInt(style.marginBottom);
      this.breakpoints.width.push($iw);
      this.breakpoints.height.push($ih);
      document.querySelector('#cards').removeChild($div);
    }

    this.masisMove = new MasisMove(this.masis, {
      class: 'ðŸ„',
      ghost: 'ðŸ‘»',
      exclude: 'ðŸ¤–',
    });

    const resizeCard = ($el, width, height, setHeight = false) => {
      for (let i = 1; i < 6; i++) {
        $el.classList.remove(`card-width-${i}`);
        if (setHeight) $el.classList.remove(`card-height-${i}`);
      }
      $el.classList.add(`card-width-${width}`);
      if (setHeight) $el.classList.add(`card-height-${height}`);
    };

    this.masisResize = new MasisResize(this.masis, {
      class: 'ðŸ“',
      active: 'ðŸ“œ',
      selector: '.card-wrapper > div',
      breakpoints: this.breakpoints,
      callbackMove: ($card, w, h) => {
        let newW = parseInt(w) + parseInt($card.dataset.cardWidth);
        let newH = parseInt(h) + parseInt($card.dataset.cardHeight);
        if (newW < parseInt($card.dataset.cardMinWidth))
          newW = parseInt($card.dataset.cardMinWidth);
        if (newH < parseInt($card.dataset.cardMinHeight))
          newH = parseInt($card.dataset.cardMinHeight);
        if (newW > self.maxCardWidthSize) newW = self.maxCardWidthSize;
        if (newH > self.maxCardHeightSize) newW = self.maxCardHeightSize;
        resizeCard($card.querySelector('.card-title'), newW, newH);
        resizeCard(
          $card.querySelector('.card-wrapper > div'),
          newW,
          newH,
          true
        );
        $card.dataset.cardTmpWidth = newW;
        $card.dataset.cardTmpHeight = newH;
        MasisPosition(self.masis);
      },
      callbackEnd: ($card) => {
        $card.dataset.cardWidth = $card.dataset.cardTmpWidth;
        $card.dataset.cardHeight = $card.dataset.cardTmpHeight;
      },
    });

    this.masisDelete = new MasisDelete(this.masis, {
      class: 'ðŸ—‘ï¸',
      message: 'Etes-vous sÃ»r de vouloir supprimer cette tuile ?',
    });

    MasisPosition(this.masis, this.positionOptions);

    const resizeObserver = new ResizeObserver((entries) => {
      MasisPosition(this.masis, this.positionOptions);
    });

    resizeObserver.observe(document.querySelector('#cards'));

    let wrenchState = false;

    document.querySelector('#button-design').addEventListener(
      'click',
      (ev) => {
        ev.preventDefault();
        wrenchState = !wrenchState;
        ev.currentTarget.classList.remove('active');
        if (wrenchState) {
          ev.currentTarget.classList.add('active');
          self.masis.$children.forEach(($el) => {
            $el.classList.add('ðŸ„');
          });
        } else {
          self.masis.$children.forEach(($el) => {
            $el.classList.remove('ðŸ„');
          });
        }
      },
      false
    );
  }

  viewPage(slug) {
    for (let page of this.pages) {
      if (page.slug == slug) {
        if (page.background != '') {
          let $cover = document.querySelector('#illustration .cover');
          $cover.style.backgroundImage = `url(${page.background})`;
        }
        let $sidebar_items = document.querySelectorAll('#menu a');
        $sidebar_items.forEach((el) => {
          el.parentNode.classList.remove('active');
          if (el.getAttribute('href') == `#/${page.slug}`)
            el.parentNode.classList.add('active');
        });
        this.populate(page.cards);
        break;
      }
    }
  }

  generateCard(card) {
    let $card = this.createCard(
      card.width,
      card.height,
      card.title,
      this.components[card.type].render(card.properties),
      typeof card.battery != undefined ? card.battery : -1,
      typeof card.signal != undefined ? card.signal : -1
    );
    const cls = ['ease-in-expo'];
    $card.classList.add(...cls);
    // some datas to resize / move / ...
    $card.dataset.cardWidth = card.width;
    $card.dataset.cardMinWidth = card.minWidth;
    $card.dataset.cardHeight = card.height;
    $card.dataset.cardMinHeight = card.minHeight;
    $card.dataset.sort = MasisMove.joliNumber(card.index);
    document.querySelector('#cards').appendChild($card);
    this.components[card.type].init($card);
  }

  populate(cards) {
    document.querySelector('#cards').innerHTML = '';
    let self = this;
    let cranberries = [];
    cards.forEach((card) => {
      cranberries.push(
        new Promise((resolve) => {
          Yadoms.useComponent(card.type).then(() => {
            self.generateCard(card);
            resolve();
          });
        })
      );
    });
    Promise.all(cranberries).then(() => {
      this.masis.populate();
      MasisSort(this.masis, '[data-sort]');
      this.masisMove.init();
      this.masisResize.init();
      this.masisDelete.init();
      MasisPosition(this.masis);
    });
  }

  static makeDigital(value, hollow = true, format = '8.8.8.8.8.8.8.8.') {
    if (hollow)
      return `
        <div class="digital">
          <span class="hollow font-mono">${format}</span>
          <span class="digits font-mono">${value}</span>
        </div>
      `;
    else
      return `
        <div class="digital">
          <span class="digits">${value}</span>
        </div>
      `;
  }

  static _load(tag, url) {
    return new Promise((resolve, reject) => {
      let $element = document.createElement(tag);
      let parent = 'body';
      let attr = 'src';
      $element.onload = function () {
        resolve(url);
      };
      $element.onerror = function () {
        reject(url);
      };
      switch (tag) {
        case 'script':
          $element.async = true;
          break;
        case 'link':
          $element.type = 'text/css';
          $element.rel = 'stylesheet';
          attr = 'href';
          parent = 'head';
      }
      $element[attr] = url;
      if (parent == 'body') document[parent].appendChild($element);
      else document[parent].insertBefore($element, document[parent].firstChild);
    });
  }

  static loader(...urls) {
    const cranberries = [];
    urls.forEach((url) => {
      if (url.endsWith('.js')) cranberries.push(Yadoms._load('script', url));
      if (url.endsWith('.css')) cranberries.push(Yadoms._load('link', url));
    });
    return Promise.all(cranberries);
  }

  static useComponent(type) {
    return new Promise((resolve) => {
      if (!Object.keys(window.yadoms.components).includes(type)) {
        import(`/components/${type}.mjs`).then((Component) => {
          if (!Object.keys(window.yadoms.components).includes(type)) {
            let component = new Component.YadomsComponent();
            window.yadoms.components[type] = component;
            window.yadoms.$style.innerHTML += component.style();
          }
          resolve(window.yadoms.components[type]);
        });
      } else resolve(window.yadoms.components[type]);
    });
  }
}

window.yadoms = new Yadoms();

Yadoms.ready(() => {
  fetch('/yadoms.instance.json')
    .then((response) => response.json())
    .then((json) => {
      window.yadoms.pages = json.instance.pages;
      window.yadoms.createMenu();
      window.yadoms.createNavigationSystem();
      window.yadoms.createCardManagementSystem();
      window.yadoms.viewPage(window.location.hash.slice(2));
    });
});

class MasisDelete {
  Masis = null;
  options = {};

  constructor(Masis, options) {
    this.Masis = Masis;
    this.options = options;
  }

  init() {
    let self = this;
    this.Masis.$children.forEach(($el) => {
      let $div = document.createElement('div');
      $div.classList.add(self.options.class);
      $div.addEventListener(
        'mousedown',
        (ev) => {
          self.removeChild(ev);
        },
        false
      );
      $el.appendChild($div);
    });
  }

  removeChild(ev) {
    ev.preventDefault();
    ev.stopImmediatePropagation();
    if (confirm(this.options.message)) {
      Yadoms.triggerEvent('masis.delete', {
        element: ev.currentTarget.parentNode,
      });
      this.Masis.$element.removeChild(ev.currentTarget.parentNode);
      MasisPosition(this.Masis.populate());
    }
  }
}

class Masis {
  constructor(selector) {
    let $elements, returns;
    $elements = document.querySelectorAll(selector);
    returns = [];
    let self = this;
    $elements.forEach(($el) => {
      return returns.push(self._init($el));
    });
    if (returns.length == 0) {
      return null;
    }
    if (returns.length === 1) {
      return returns[0];
    }
    return returns;
  }
  _init($element) {
    this.$element = $element;
    return this.populate();
  }

  populate() {
    this.$children = [];
    let children = this.$element.children;
    Array.from(children).forEach(($el) => {
      if ($el.nodeType !== 8) this.$children.push($el);
    });
    this.$actives = this.$children;
    return this.view();
  }

  view(nb = 0, start = 0) {
    nb = parseInt(nb);
    this.$children.forEach(($el) => {
      $el.style.display = 'none';
    });
    this.$actives.forEach(($el, i) => {
      if (!nb || (nb && start <= i && i < nb + start)) {
        $el.style.display = '';
      }
    });
    return this;
  }
}

const _Masis = Masis;

function MasisFilter(Masis, selector = '*') {
  if ('*' == selector) Masis.$actives = Masis.$children;
  else {
    let match = function ($el, selector) {
      return (
        $el.matches ||
        $el.matchesSelector ||
        $el.msMatchesSelector ||
        $el.mozMatchesSelector ||
        $el.webkitMatchesSelector ||
        $el.oMatchesSelector
      ).call($el, selector);
    };
    let matches = [];
    Masis.$actives.forEach(($el) => {
      if (match($el, selector)) matches.push($el);
    });
    Masis.$actives = matches;
    return Masis.view();
  }
}

function MasisLazy(Masis, threshold = 0, attr = 'data-src', callback = null) {
  let wHeight = window.innerHeight || document.documentElement.clientHeight;
  let lazyload = () => {
    Masis.$element
      .querySelectorAll('img[' + attr + ']')
      .array.forEach(($img) => {
        let rect = $img.getBoundingClientRect();
        let top = rect.top;
        if (-threshold <= top - threshold && top <= wheight) {
          $img.setAttribute('src', $img.getAttribute(attr));
          $img.removeAttribute(attr);
          $img.style.opacity = 1;
          return $img.addEventListener(
            'load',
            function () {
              if (callback != null) {
                return callback($img);
              }
            },
            false
          );
        }
      });
  };
  let lazytime = null;
  window.addEventListener(
    'scroll',
    function () {
      clearTimeout(lazytime);
      lazytime = setTimeout(function () {
        lazyload();
      }, 10);
    },
    false
  );
  lazyload();
  return this;
}

function MasisPosition(Masis, opts = {}) {
  if (opts.pad == null) opts.pad = 1;
  let width = parseInt(Masis.$element.offsetWidth);
  Masis.$element.style.position = 'relative';
  let hs = [];
  for (let i = 0; i < width; i++) hs[i] = 0;
  let max = function (x, w, hs) {
    let i = 0,
      j = hs[x];
    while ((i += opts.pad) < w) {
      if (j < hs[x + i]) {
        j = hs[x + i];
      }
    }
    return j;
  };
  Masis.$actives.forEach(($el) => {
    $el.style.position = 'absolute';
    const style = getComputedStyle($el);
    const rect = $el.getBoundingClientRect();
    let $iw, $ih;
    $iw =
      parseInt(rect.width) +
      parseInt(style.marginLeft) +
      parseInt(style.marginRight);
    $ih =
      parseInt(rect.height) +
      parseInt(style.marginTop) +
      parseInt(style.marginBottom);
    let x = 0,
      j = 0,
      h = Infinity,
      _h = h;
    while (j <= width) {
      let k = j - opts.pad;
      let _w = j + $iw;
      while (k++ <= _w) {
        let _k = k + $iw;
        if (_k <= width) {
          _h = $ih + max(k, $iw, hs);
          if (h > _h) {
            h = _h;
            x = k;
          }
        }
      }
      j += $iw;
    }
    $el.style.left = x + 'px';
    $el.style.top = h - $ih + 'px';
    j = $iw;
    while (j--) {
      hs[j + x] = h;
    }
  });
  Masis.$element.style.height = Math.max.apply(Math, hs) + 'px';
  return Masis;
}

function MasisSort(Masis, type = 'text', way = 'ASC') {
  way = way.toUpperCase();
  let children = Array.from(Masis.$children);
  children.sort(($a, $b) => {
    const t = type.slice(1, -1);
    let va = type !== 'text' ? $a.getAttribute(t) : $a.innerHTML;
    let vb = type !== 'text' ? $b.getAttribute(t) : $b.innerHTML;
    const r = way === 'ASC' ? 1 : -1;
    if (va == null) va = '';
    if (vb == null) vb = '';
    return r * va.localeCompare(vb);
  });
  for (let i = 0; i < children.length; i++)
    Masis.$element.appendChild(children[i]);
  return Masis.populate();
}

class MasisMove {
  Masis = null;
  options = {};
  $ghost;
  positions;
  oldpos = '';
  onDrag = false;

  constructor(Masis, options = {}) {
    this.Masis = Masis;
    if (options.attr == null) options.attr = 'data-sort';
    if (options.ghost == null) options.ghost = 'ghost';
    this.options = options;

    let self = this;

    document.addEventListener(
      'mousemove',
      (ev) => {
        self.moveGhost(ev);
      },
      false
    );
    this.redefineSort();
  }

  init() {
    let self = this;
    this.Masis.$children.forEach(($el) => {
      $el.addEventListener(
        'mousedown',
        (ev) => {
          self.createGhost(ev);
        },
        false
      );
      $el.addEventListener(
        'mouseup',
        (ev) => {
          self.removeGhost(ev);
        },
        false
      );
    });
  }

  static pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
  }

  static joliNumber(num) {
    return `_${MasisMove.pad(num, 6, '0')}`;
  }

  redefineSort() {
    let self = this;
    this.Masis.$children.forEach(($el, i) => {
      $el.setAttribute(this.options.attr, MasisMove.joliNumber(i + 1));
    });
  }

  generatePositionsMap() {
    this.positions = {};
    let self = this;
    this.Masis.$children.forEach(($el) => {
      let et = MasisMove.joliNumber($el.style.top.replace('px', ''));
      let el = MasisMove.joliNumber($el.style.left.replace('px', ''));
      if (typeof self.positions[et] == 'undefined') self.positions[et] = {};
      self.positions[et][el] = $el.getAttribute(self.options.attr);
    });
  }

  createFake(newPos) {
    let $robot = this.Masis.$element.querySelector('#' + this.options.exclude);
    if ($robot != null) this.Masis.$element.removeChild($robot);
    $robot = document.createElement('div');
    $robot.setAttribute('id', this.options.exclude);
    $robot.classList = this.$ghost.classList;
    $robot.classList.remove(this.options.ghost);
    $robot.innerHTML = this.$ghost.innerHTML;
    $robot.setAttribute(this.options.attr, newPos);
    this.Masis.$element.appendChild($robot);
  }

  moveGhost(ev) {
    if (!this.onDrag) return;
    ev.preventDefault();
    let newX = ev.pageX;
    let newY = ev.pageY;
    newX -= 90;
    newY -= 50;
    this.$ghost.style.left = newX + 'px';
    this.$ghost.style.top = newY + 'px';
    let _x = MasisMove.joliNumber(newX);
    let _y = MasisMove.joliNumber(newY);
    if (this.positions != null) {
      let positionsY = Object.keys(this.positions).reverse();
      let newPos = MasisMove.joliNumber(0);
      for (let i in positionsY)
        if (positionsY[i].localeCompare(_y) == -1) {
          let positionsX = Object.keys(this.positions[positionsY[i]]).reverse();
          for (let j in positionsX)
            if (positionsX[j].localeCompare(_x) == -1) {
              newPos =
                MasisMove.joliNumber(
                  parseInt(
                    this.positions[positionsY[i]][positionsX[j]].replace(
                      '_',
                      ''
                    )
                  )
                ) + '_';
              break;
            }
          break;
        }
      if (newPos != this.oldpos) {
        this.createFake(newPos);
        MasisPosition(MasisSort(this.Masis.populate(), '[data-sort]'));
        this.oldpos = newPos;
      }
    }
  }

  createGhost(ev) {
    if (ev.currentTarget.classList.contains(this.options.exclude)) return;
    if (!ev.currentTarget.classList.contains(this.options.class)) return;
    this.onDrag = true;
    this.$ghost = event.currentTarget;
    this.Masis.$element.parentNode.appendChild(this.$ghost);
    this.$ghost.classList.add(this.options.ghost);
    this.createFake(this.$ghost.getAttribute(this.options.attr));
    MasisPosition(MasisSort(this.Masis.populate(), '[data-sort]'));
    this.generatePositionsMap();
  }

  removeGhost(ev) {
    if (this.$ghost != null) {
      this.$ghost.classList.remove(this.options.ghost);
      this.moveGhost(ev);
      let $robot = this.Masis.$element.querySelector(
        '#' + this.options.exclude
      );
      this.$ghost.setAttribute(
        this.options.attr,
        $robot.getAttribute(this.options.attr)
      );
      this.Masis.$element.removeChild($robot);
      this.Masis.$element.appendChild(this.$ghost);
      MasisPosition(MasisSort(this.Masis.populate(), '[data-sort]'));
      this.redefineSort();
      this.oldpos = '';
      this.onDrag = false;
      Yadoms.triggerEvent('masis.moved');
    }
  }
}

class MasisResize {
  Masis = null;
  options = {};

  onResize = false;
  $element;
  offsetX;
  offsetY;
  previousX;
  previousY;

  constructor(Masis, options) {
    this.Masis = Masis;
    this.options = options;
    let self = this;
    document.addEventListener(
      'mousemove',
      (ev) => {
        this.resize(ev);
      },
      false
    );
    document.addEventListener(
      'mouseup',
      (ev) => {
        this.deleteResize(ev);
      },
      false
    );
  }

  init() {
    let self = this;
    this.Masis.$children.forEach(($el) => {
      let $div = document.createElement('div');
      $div.classList.add(self.options.class);
      $div.addEventListener(
        'mousedown',
        (ev) => {
          self.createResize(ev);
        },
        false
      );
      $el.appendChild($div);
    });
  }

  createResize(ev) {
    ev.preventDefault();
    ev.stopImmediatePropagation();
    if (!ev.target.classList.contains(this.options.class)) return;
    this.onResize = true;
    this.$element = ev.currentTarget.parentNode;
    this.$element.classList.add(this.options.active);
    this.offsetX = 0;
    this.offsetY = 0;
    this.previousX = ev.pageX;
    this.previousY = ev.pageY;
  }

  deleteResize() {
    this.onResize = false;
    if (this.$element) {
      this.$element.classList.remove(this.options.active);
      let self = this;
      Yadoms.triggerEvent('masis.resize', {
        element: self.$element,
      });
      this.options.callbackEnd(this.$element);
    }
    this.$element = null;
  }

  resize(ev) {
    if (!this.onResize) return;
    ev.preventDefault();
    if (this.$element != null) {
      let width = this.options.breakpoints.width.length - 1;
      let height = this.options.breakpoints.height.length - 1;
      this.offsetX += ev.pageX - this.previousX;
      this.offsetY += ev.pageY - this.previousY;
      this.previousX = ev.pageX;
      this.previousY = ev.pageY;
      for (let i in this.options.breakpoints.width)
        if (this.options.breakpoints.width[i] > Math.abs(this.offsetX)) {
          width = parseInt(i);
          break;
        }
      for (let i in this.options.breakpoints.height)
        if (this.options.breakpoints.height[i] > Math.abs(this.offsetY)) {
          height = parseInt(i);
          break;
        }
      if (this.offsetX < 0) width *= -1;
      if (this.offsetY < 0) height *= -1;
      this.options.callbackMove(this.$element, width, height);
    }
  }
}
